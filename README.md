# VDPG: Adapting to Distribution Shift by Visual Domain Prompt Generation (ICLR 2024)
[Paper](https://openreview.net/pdf?id=TD3SGJfBC7)

## ðŸ’¡ Abstract
Few-shot Test-Time Domain Adaptation focuses on adapting a model at test time to a specific domain using only a few unlabeled examples, addressing domain shift. Prior methods leverage CLIP's strong out-of-distribution (OOD) abilities by generating domain-specific prompts to guide its generalized, frozen features. However, since downstream datasets are not explicitly seen by CLIP, solely depending on the feature space knowledge is constrained by CLIP's prior knowledge. Notably, when using a less robust backbone like ViT-B/16, performance significantly drops on challenging real-world benchmarks. Departing from the state-of-the-art of inheriting the intrinsic OOD capability of CLIP, this work introduces learning directly on the input space to complement the dataset-specific knowledge for frozen CLIP. Specifically, an independent side branch is attached in parallel with CLIP and enforced to learn exclusive knowledge via revert attention.  To better capture the dataset-specific label semantics for downstream adaptation, we propose to enhance the inter-dispersion among text features via greedy text ensemble and refinement. The text and visual features are then progressively fused in a domain-aware manner by a generated domain prompt to adapt toward a specific domain. Extensive experiments show our method's superiority on 5 large-scale benchmarks (WILDS and DomainNet), notably improving over smaller networks like ViT-B/16 with gains of \textbf{+5.1} in F1 for iWildCam and \textbf{+3.1\%} in WC Acc for FMoW. 

## Installation
### Requirements
```bash
pip install -r torch21_cu118_py39.yml
```

### Download CLIP's pretrained weights
From [open_clip](https://github.com/mlfoundations/open_clip/blob/main/docs/PRETRAINED.md) to 
```bash
./modelzoo/openai_clip
```
### Download datasets
**WILDS**

Please follow the download instructions provided by [WILDS benchmark](https://github.com/p-lambda/wilds/) to download iWildCam, Camelyon17, FMoW and ProvertyMap to the folder of `./data`

**DomainNet**

1. Download the official [DomainNet benchmark](http://ai.bu.edu/M3SDA/) to `./data`
2. Generate a metadata.csv for DomainNet by running the [WILDS preprocessing script](https://github.com/p-lambda/wilds/blob/472677590de351857197a9bf24958838c39c272b/dataset_preprocessing/domainnet/generate_metadata.py).

Noted, we evaluate the **`official test split`** of DomainNet instead of the random split of the target domain as in [DomainBed](https://github.com/facebookresearch/DomainBed) codebase.

## Project Structure
Reference: [lightning-hydra-template](https://github.com/ashleve/lightning-hydra-template/)

```
â”œâ”€â”€ configs                   <- Hydra configs
â”‚   â”œâ”€â”€ callbacks                <- Callbacks configs
â”‚   â”œâ”€â”€ data                     <- Data configs
â”‚   â”œâ”€â”€ experiment               <- Experiment configs
â”‚   â”œâ”€â”€ extras                   <- Extra utilities configs
â”‚   â”œâ”€â”€ logger                   <- Logger configs
â”‚   â”œâ”€â”€ model                    <- Model configs
â”‚   â”œâ”€â”€ paths                    <- Project paths configs
â”‚   â”œâ”€â”€ trainer                  <- Trainer configs
â”‚   â”œâ”€â”€ eval.yaml             <- Main config for evaluation
â”‚   â””â”€â”€ train.yaml            <- Main config for training
â”‚
â”œâ”€â”€ logs                   <- Logs generated by hydra and lightning loggers
â”œâ”€â”€ modelzoo               <- pretrained model weights
â”œâ”€â”€ data                   <- downloaded datasets
â”œâ”€â”€ src                    <- Source code
â”‚   â”œâ”€â”€ datasets                <- benchmark datasets
â”‚   â”œâ”€â”€ models                  <- model components
â”‚   â”œâ”€â”€ lightning               <- LightningModule, DataModule, Callbacks
â”‚   â”œâ”€â”€ solver                  <- losses, solvers, schedulers
â”‚   â”œâ”€â”€ utils                   <- Utility modules
â”œâ”€â”€ train.py                    <- Run training
â”œâ”€â”€ eval.py                     <- Run evaluation
â”‚
â”œâ”€â”€ .env                      <- Example of file for storing private environment variables
â”œâ”€â”€ .project-root             <- File for inferring the position of project root directory
â”œâ”€â”€ requirements.yml          <- File for installing pip environment
â””â”€â”€ README.md
```
<br>

## Evaluation
### Download pretrained checkpoints 
From [OneDrive](https://utoronto-my.sharepoint.com/:f:/g/personal/zhixiang_chi_mail_utoronto_ca/EuOsVq42nAlCvLm2_F3se5wBvD7ufOcuvUsdlCy5sPjRzQ?e=8bAYcE) and save in the folder of `./modelzoo`

### DomainNet
```bash
python eval.py model=vdpg_ViT_B16_CLIP.yaml paths.data_dir="./data" data=<data_name> ckpt_path=./modelzoo/<ckpt_name>
```

For example, we run the evaluation using DomainNet's sketch domain as the out-of-distribution.
```bash
python eval.py model=vdpg_ViT_B16_CLIP.yaml paths.data_dir="./data" data=domainnet_sketch_contrastive.yaml ckpt_path=./modelzoo/domainnet_sketch.ckpt
```
### WILDS
iWildCam: 
``` bash
python eval.py model.model.num_prompts=100 paths.data_dir="./data" data=iwild_contrastive ckpt_path=./modelzoo/iWildCam.ckpt
```

Camelyon: 
``` bash
python eval.py model.model.num_prompts=5 paths.data_dir="./data" data=camelyon17_contrastive ckpt_path=./modelzoo/Camelyon.ckpt
```

FMoW: 
``` bash
python eval.py model.model.num_prompts=5 paths.data_dir="./data" data=fmow_contrastive ckpt_path=./modelzoo/FMoW.ckpt
```


## <a name="cite"/> :clipboard: Citation

If you use this code in your research, please consider citing our paper:
```
@inproceedings{chi_2024_ICLR,
  title={Adapting to Distribution Shift by Visual Domain Prompt Generation},
  author={Zhixiang Chi, Li Gu, Tao Zhong, Huan Liu, Yuanhao Yu, Konstantinos N Plataniotis, Yang Wang},
  booktitle={Proceedings of the Twelfth International Conference on Learning Representations},
  year={2024}
}

@inproceedings{
zhong2022metadmoe,
title={Meta-{DM}oE: Adapting to Domain Shift by Meta-Distillation from Mixture-of-Experts},
author={Tao Zhong and Zhixiang Chi and Li Gu and Yang Wang and YUANHAO YU and Jin Tang},
booktitle={Advances in Neural Information Processing Systems},
editor={Alice H. Oh and Alekh Agarwal and Danielle Belgrave and Kyunghyun Cho},
year={2022},
url={https://openreview.net/forum?id=_ekGcr07Dsp}
}
```
